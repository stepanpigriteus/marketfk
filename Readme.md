# MarketFlow - Структура проекта и пошаговый план

## Структура проекта (Гексагональная архитектура)

```
marketflow/
├── cmd/
│   ├── marketflow/          # Основной бинарник приложения
│   │   └── main.go
│   └── testgen/             # Генератор тестовых данных
│       └── main.go
├── internal/
│   ├── domain/              # Доменный слой
│   │   ├── model/           # Доменные модели
│   │   │   ├── market.go    # Модель рыночных данных
│   │   │   └── exchange.go  # Модель биржи
│   │   └── service/         # Доменные сервисы
│   │       └── market.go    # Сервис обработки рыночных данных
│   ├── application/         # Прикладной слой
│   │   ├── usecase/         # Реализация сценариев использования
│   │   │   ├── price_fetcher.go   # Получение цен
│   │   │   ├── price_aggregator.go # Агрегация цен
│   │   │   └── mode_manager.go    # Управление режимами
│   │   └── port/            # Порты для адаптеров
│   │       ├── in/          # Входные порты
│   │       │   ├── http.go  # Порты для REST API
│   │       │   └── exchange.go # Порты для обработки данных с бирж
│   │       └── out/         # Выходные порты
│   │           ├── storage.go  # Порт для хранилища
│   │           ├── cache.go    # Порт для кеша
│   │           └── exchange.go # Порт для получения данных с бирж
│   └── adapter/            # Адаптеры
│       ├── in/             # Входящие адаптеры
│       │   ├── http/       # HTTP адаптер
│       │   │   ├── handler/ # Обработчики запросов
│       │   │   │   ├── price.go   # Обработчики для цен
│       │   │   │   ├── mode.go    # Обработчики для режимов
│       │   │   │   └── health.go  # Обработчик для проверки здоровья
│       │   │   ├── server.go # HTTP сервер
│       │   │   └── router.go # Роутер
│       │   └── exchange/    # Адаптеры для бирж
│       │       ├── live/    # Адаптер для живых данных
│       │       │   └── connector.go # Коннектор к биржам
│       │       └── test/    # Адаптер для тестовых данных
│       │           └── connector.go # Коннектор к тест-генератору
│       └── out/            # Исходящие адаптеры
│           ├── storage/    # Адаптер хранилища
│           │   └── postgres/ # PostgreSQL адаптер
│           │       ├── repository.go # Репозиторий
│           │       └── mapper.go    # Маппер данных
│           ├── cache/      # Адаптер кеша
│           │   └── redis/  # Redis адаптер
│           │       ├── cache.go  # Реализация кеша
│           │       └── mapper.go # Маппер данных
│           └── exchange/   # Адаптер для получения данных с бирж
│               ├── live/   # Живой обмен
│               │   └── client.go # Клиент для подключения
│               └── test/   # Тестовый обмен
│                   └── client.go # Клиент для подключения
├── pkg/                   # Общие пакеты
│   ├── config/            # Конфигурация
│   │   ├── config.go      # Модель конфигурации
│   │   └── loader.go      # Загрузчик конфигурации
│   ├── concurrency/       # Утилиты для конкурентности
│   │   ├── fan_in.go      # Fan-In шаблон
│   │   ├── fan_out.go     # Fan-Out шаблон
│   │   └── worker_pool.go # Worker Pool шаблон
│   └── logger/            # Логирование
│       └── logger.go      # Настройка логгера
├── configs/               # Файлы конфигурации
│   ├── app.yaml           # Основная конфигурация
│   └── ...
├── deployments/           # Конфигурация для развертывания
│   ├── docker-compose.yml # Docker Compose для запуска всех компонентов
│   └── Dockerfile         # Dockerfile для сборки образа
├── scripts/               # Вспомогательные скрипты
│   └── ...
├── go.mod                 # Go модули
└── go.sum                 # Хеши модулей
```

## Пошаговый план реализации (TODO)

### Этап 1: Настройка проекта и базовая структура

1. **Настройка проекта**
   - Создать директорию проекта и инициализировать Go модуль
   - Настроить .gitignore файл
   - Создать базовые директории согласно структуре

2. **Реализация системы конфигурации**
   - Создать структуру для хранения конфигурации (PostgreSQL, Redis, порты и т.д.)
   - Реализовать загрузку конфигурации из файла

3. **Настройка логирования**
   - Создать пакет для логирования с использованием log/slog
   - Реализовать разные уровни логирования и форматирование

### Этап 2: Доменный слой

1. **Реализация доменных моделей**
   - Создать модель для рыночных данных (MarketData)
   - Создать модель для бирж (Exchange)
   - Создать модель для торговых пар (TradingPair)

2. **Реализация основных доменных сервисов**
   - Создать сервис для обработки рыночных данных
   - Реализовать базовую бизнес-логику

### Этап 3: Прикладной слой

1. **Определение портов (интерфейсов)**
   - Создать входные порты для REST API
   - Создать выходные порты для хранилища, кеша и подключения к биржам

2. **Реализация use-cases**
   - Реализовать получение цен с бирж
   - Реализовать агрегацию и обработку цен
   - Реализовать переключение между режимами (Live/Test)

### Этап 4: Адаптеры для хранения данных

1. **Реализация PostgreSQL адаптера**
   - Создать схему базы данных
   - Реализовать репозиторий для сохранения и получения данных
   - Реализовать пакетное сохранение данных

2. **Реализация Redis адаптера**
   - Реализовать кеширование последних цен
   - Реализовать хранение временных рядов для расчета средних значений
   - Настроить автоматическое удаление устаревших данных

### Этап 5: Адаптеры для подключения к биржам

1. **Реализация адаптера для живых данных**
   - Создать клиент для подключения к биржам по TCP
   - Реализовать парсинг данных
   - Реализовать механизм переподключения при обрыве связи

2. **Реализация генератора тестовых данных**
   - Создать отдельное приложение для генерации синтетических данных
   - Реализовать TCP сервер, имитирующий биржи
   - Настроить генерацию данных для заданных торговых пар

### Этап 6: Реализация паттернов конкурентности

1. **Fan-In Pattern**
   - Реализовать агрегацию данных с разных источников в один канал

2. **Fan-Out Pattern**
   - Реализовать распределение данных между обработчиками

3. **Worker Pool**
   - Создать пул воркеров для обработки входящих данных
   - Настроить балансировку нагрузки между воркерами

### Этап 7: REST API

1. **Реализация HTTP-сервера**
   - Настроить роутинг
   - Реализовать middleware для логирования, обработки ошибок и т.д.

2. **Реализация обработчиков для API точек**
   - Реализовать получение последних цен
   - Реализовать получение максимальных/минимальных/средних цен
   - Реализовать переключение режимов
   - Реализовать проверку состояния системы

### Этап 8: Корректное завершение работы

1. **Реализация graceful shutdown**
   - Обработка сигналов SIGINT и SIGTERM
   - Корректное закрытие всех соединений
   - Завершение всех горутин

### Этап 9: Сборка и упаковка

1. **Написание Dockerfile**
   - Создать Dockerfile для сборки образа

2. **Создание Docker Compose**
   - Настроить docker-compose.yml для запуска всей системы
   - Включить PostgreSQL, Redis и MarketFlow в одной конфигурации

### Этап 10: Тестирование

1. **Написание модульных тестов**
   - Протестировать основные компоненты системы

2. **Интеграционное тестирование**
   - Протестировать взаимодействие между компонентами

3. **Нагрузочное тестирование**
   - Проверить производительность системы при высокой нагрузке

### Этап 11: Документация

1. **Создание документации по API**
   - Описать все API эндпоинты
   - Привести примеры запросов и ответов

2. **Создание документации по использованию**
   - Описать порядок установки и запуска
   - Привести примеры использования

## Детали реализации основных компонентов

### Конкурентная обработка данных
1. **Fan-In Pattern**: Создать функцию, которая объединяет данные из нескольких каналов в один.
2. **Fan-Out Pattern**: Создать функцию, которая распределяет данные из одного канала на несколько.
3. **Worker Pool**: Создать пул воркеров, которые будут обрабатывать данные из каналов.

### Хранение данных
1. **PostgreSQL**: Создать таблицу для хранения агрегированных данных.
2. **Redis**: Хранить последние цены в кеше для быстрого доступа.

### API
1. **REST API**: Реализовать все требуемые эндпоинты.
2. **Health checks**: Реализовать проверку состояния системы.